<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Waste Eye</title>


    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="index.js"></script>
</head>

<body>
    <!-- TOP BAR -->
    <div class="navbar">
        <div class="brand">
            <img src="./img/logo.png" style="height:50%">
            <p style="font-size:30px">WASTE EYE</p>
        </div>
        <div class="poweredby">
            <span>Powered by</span>
            <img src="img/vision.png" class="icon"><img src="img/gpt.png" class="icon">
        </div>
    </div>

    <!-- SIDE BAR -->

    <img src="./img/left-arrow.png" style="width:5vw;position:fixed;top:20px;z-index:10" id="sideNavButton"
        onclick="toggleSidebar(true)">

    <div class="sidenav">
        <br>
        <br>

        <label><b>About</b></label>
        <p>Don't know where to put your trash? <br>
            Take a picture and Waste Eye will tell you!</p>

        <hr>
        <br>

        <label for="img" style="text-align: center;"><b>Upload image from device</b><label>
                <br>
                <br>
                <input type="file" id="imgForm" name="img" accept="image/*">
                <input type="submit" onclick="submitFormPic()">

                <br>
                <br>
                <hr>
                <br>

                <label><b>Use your camera<b></label>
                <br>
                <br>

                <button onclick="startVideo()">Take a Picture</button>
                <button onclick="takePic()">Snap</button>
                <button onclick="submitPic()">Submit</button>

                <br>
                <br>
                <hr>
    </div>

    <!-- REAL MAIN BODY -->
    <div id="body__content__wrapper">
        <div id="body__spacer"></div>
        <div id="content__wrapper__2">
            <div class="center">
                <video class="videoInsert" autoplay="true" id="videoElement"></video>
                <canvas id="canvas" style="overflow: auto;"></canvas>
            </div>
            <!--Outputs generated by index.js-->
            <h2>Recommended Disposal Methods:</h2>
            <div id="output__boxes">
            </div>
        </div>
    </div>
</body>

<script>

    var hidden = false;
    var currentStream;

    function tab(tabname) {

        var img, txt
        img = document.getElementById("img")
        txt = document.getElementById("txt")

        if (tabname == "img") {
            img.style.display = "flex";
            txt.style.display = "none";
        }
        else {
            img.style.display = "none";
            txt.style.display = "flex";
        }

    }

    function toggleSidebar(bool) {
        const rotated = document.getElementById("rotated");
        if (bool) {
            document.querySelector('.sidenav').classList.toggle('closed');
            hidden = true;
        } else if (hidden) {
            //rotated.style.transform = "rotate(20deg)";
            document.querySelector('.sidenav').classList.toggle('closed');
            hidden = false;
        }
    }

    function startVideo() {
        let video = document.querySelector("#videoElement");
        let canvas = document.getElementById("canvas")
        video.removeAttribute("hidden")
        canvas.setAttribute("hidden", "hidden")

        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    video.srcObject = stream;
                    currentStream = stream;
                })
                .catch(function (error) {
                    console.log("something went wrong")
                })
        } else {
            console.log("unsupported.")
        }
    }

    function takePic() {
        var canvas = document.getElementById("canvas");
        var video = document.querySelector("video");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.removeAttribute("hidden")
        video.setAttribute("hidden", "hidden");
        
        currentStream.getTracks().forEach(function (track) {
            track.stop();
        });
    }

    async function submitPic() {
        const canvas = document.getElementById('canvas');

        const data = await requestBackendImage(canvas);

        console.log(data);
    }

    async function submitFormPic() {
        const input = document.getElementById("imgForm");
        const canvas = document.getElementById("canvas");
        var video = document.querySelector("video");

        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                var pic = new Image();
                pic.src = e.target.result;
                pic.onload = function () {
                    canvas.width = pic.width;
                    canvas.height = pic.height;
                    canvas.getContext("2d").drawImage(pic, 0, 0, canvas.width, canvas.height)
                };

            };
            canvas.removeAttribute("hidden");
            video.setAttribute("hidden", "hidden");
        }

        const data = await requestBackendImage(canvas);

        console.log(data);
    }

    async function requestBackendImage(canvas) {
        const base64 = canvas.toDataURL("image/png").replace(/^data:image\/?[A-z]*;base64,/, "");

        console.log(base64);

        const response = await fetch("http://localhost:3000/analyze", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                image: base64
            })
        });

        const data = await response.json()
        .then(data => {
            generateOutputs(data);
        })

        return data;
    }

</script>

</html>